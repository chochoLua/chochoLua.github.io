<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
        <%= title %>
    </title>
    <link rel="stylesheet" href="/css/main.css" />
    <style>
        @font-face {
            font-family: 'GmarketSansMedium';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/GmarketSansMedium.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }

        html,
        body {
            margin: 0;
            font-family: 'GmarketSansMedium';
            background: #F8F8F8;
        }
    </style>
</head>

<body class="flex justify-center items-center w-screen h-screen">
    <div id="main" class="flex flex-col p-8 my-1 rounded-lg bg-white shadow-md overflow-y-auto">
        <div id="video" class="text-center"></div>
        <div id="timer" class="text-5xl my-4 text-center"></div>
    </div>
    <script>
        const ws = {
            socket: null,
            invl: null,
            isConnected: false,
            connect() {
                if (this.socket != null && this.isConnected) {
                    this.disconnect();
                }
                this.socket = new WebSocket('wss://chorokbot.duckdns.org');
                this.socket.onopen = (event) => {
                    console.log('Connected');
                    this.isConnected = true;

                    this.socket.onmessage = (event) => {
                        const data = JSON.parse(event?.data)
                        const { type } = data;
                        if (type == 'choflix-render') {
                            if (window.choflix) {
                                window.choflix.setData(data.data);
                            }
                        }
                    }
                }

                this.socket.onclose = () => {
                    console.log('Disconnected');
                    this.socket = null;
                    this.isConnected = false;
                }
            },
            disconnect() {
                this.socket.close()
                this.invl = setInterval(() => {
                    this.connect();
                }, 5000)
            },
            send(data) {
                this.socket.send(JSON.stringify(data));
            }
        }

        const choflix = {
            data: {},
            setData(data) {
                this.data = data;
                this.render();
            },
            render() {
                const { videoMetadata } = this.data;
                const { videoInfo, season, videoId } = videoMetadata;
                const currentEpisode = season.filter(ep => ep.episodeId == videoId)
                const episodeInfo = currentEpisode[0] ?? {};

                if (videoInfo.title) {
                    document.querySelector('#video').innerHTML = `${videoInfo.title} ${episodeInfo.seq}í™” ${episodeInfo.title}`
                }
                document.querySelector('#timer').innerHTML = `${this.formatTime(this.data.currentTime)} / ${this.formatTime(this.data.duration)}`
            },
            formatTime(seconds) {
                const total = Math.floor(seconds);

                const hour = Math.floor(total / 3600);
                const min = Math.floor((total % 3600) / 60);
                const sec = total % 60;

                const pad = (n) => n.toString().padStart(2, '0');

                if (hour > 0) {
                    return `${hour}:${pad(min)}:${pad(sec)}`
                }
                return `${min}:${pad(sec)}`
            }
        }
        window.choflix = choflix;

        ws.connect();
    </script>
</body>

</html>